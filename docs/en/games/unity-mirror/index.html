<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #00aaff;
        }
    </style>

    
    
    
    
    
    

    
    <title>Unity Mirror</title>
    <meta name="description" content="Imagination can change anything!">
    <meta name="keywords" content='Unity'>

    <meta property="og:url" content="https://NYH-Dolphin.github.io/en/games/unity-mirror/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Unity Mirror">
    <meta property="og:description" content="Imagination can change anything!">
    <meta property="og:image" content="/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Unity Mirror">
    <meta name="twitter:description" content="Imagination can change anything!">
    <meta property="twitter:domain" content="https://NYH-Dolphin.github.io/en/games/unity-mirror/">
    <meta property="twitter:url" content="https://NYH-Dolphin.github.io/en/games/unity-mirror/">
    <meta name="twitter:image" content="/images/avatar.jpg">

    
    <link rel="canonical" href="https://NYH-Dolphin.github.io/en/games/unity-mirror/" />

    <link rel="stylesheet" type="text/css" href="https://NYH-Dolphin.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://NYH-Dolphin.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://NYH-Dolphin.github.io/css/dark.css">

    <script src="https://NYH-Dolphin.github.io/js/svg-injector.min.js"></script>
    <script src="https://NYH-Dolphin.github.io/js/feather-icons.min.js"></script>
    <script src="https://NYH-Dolphin.github.io/js/main.js"></script>

    
    
    
    
    <script src="https://player.lzti.com/api/player/167601724233" id="myhk" key="167601724233" m="1"></script>



    <!-- Support Letax Equation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js" integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>

    <!-- Katex is a math typesetting library for the web which lets you write beautiful equations.-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <!-- Analysis -->
    <script async defer data-website-id="website-id" src="https://analytics.example.com/script.js"></script>

    <!-- Support Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://NYH-Dolphin.github.io">
                <img src="https://NYH-Dolphin.github.io/images/avatar.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://NYH-Dolphin.github.io">Dolphin NIE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/sharing/"><span data-feather='share-2'></span> Sharing </a>
            </div>
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/study/"><span data-feather='book-open'></span> Study </a>
            </div>
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/project/"><span data-feather='code'></span> Project </a>
            </div>
            
            <div class="nav-link">
                <a href="https://nyh-dolphin.itch.io/"><span data-feather='gift'></span> Itch </a>
            </div>
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/en/about/"><span data-feather='smile'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/tags/"><span data-feather='tag'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/NYH-Dolphin"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://NYH-Dolphin.github.io/../zh"> 中文 </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/sharing/"><span data-feather='share-2'></span> Sharing </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/study/"><span data-feather='book-open'></span> Study </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/project/"><span data-feather='code'></span> Project </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://nyh-dolphin.itch.io/"><span data-feather='gift'></span> Itch </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/en/about/"><span data-feather='smile'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/tags/"><span data-feather='tag'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/NYH-Dolphin"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://NYH-Dolphin.github.io/../zh"> 中文 </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Unity Mirror</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            May 13, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://NYH-Dolphin.github.io/en/tags/unity">Unity</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h2 id="1-mirror-介绍">1. Mirror 介绍</h2>
<ul>
<li>
<p>Mirror 是完全免费的，它有很好的文档和说明</p>
</li>
<li>
<p>Github Link: <a href="https://github.com/vis2k/Mirror">https://github.com/vis2k/Mirror</a></p>
</li>
<li>
<p>文档：https://mirror-networking.gitbook.io/docs/</p>
</li>
<li>
<p>教程</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1q3411e7QV?spm_id_from=333.337.search-card.all.click">https://www.bilibili.com/video/BV1q3411e7QV?spm_id_from=333.337.search-card.all.click</a></li>
<li><a href="https://www.youtube.com/watch?v=77vYKsXC4IE&amp;list=PLXEG2omgKgCapAmGe20XBgd87rmxFdKhK&amp;index=3">https://www.youtube.com/watch?v=77vYKsXC4IE&amp;list=PLXEG2omgKgCapAmGe20XBgd87rmxFdKhK&amp;index=3</a></li>
</ul>
</li>
<li>
<p>SDK：https://mirror-networking.com/docs/api/Mirror.html</p>
</li>
<li>
<p>先修</p>
<ul>
<li>C#</li>
<li>Unity  基础操作</li>
<li>网络相关知识</li>
</ul>
</li>
</ul>
<h3 id="安装">安装</h3>
<ul>
<li>通过 Assets Store 可以直接下载 Mirror
<ul>
<li>当安装好后，你会有一个 <code>Mirror</code> 文件夹和一个 <code>ScriptTemplates</code> 文件夹</li>
</ul>
</li>
<li>在 Mirror/Examples 下面有一个 <code>Pong</code> 的文件夹，我们将以它为示例</li>
</ul>
<h2 id="2-pong-游戏介绍">2. Pong 游戏介绍</h2>
<h3 id="介绍">介绍</h3>
<img src="/images/Unity Mirror.assets/image-20220513092714779.png" alt="image-20220513092714779"/>	
<ul>
<li>
<p>首先，打包一个文件出来，可以用来做 Server，Unity 内的用于 Client</p>
</li>
<li>
<p>运行 exe 文件，可以看到游戏内有一些按钮</p>
<img src="/images/Unity Mirror.assets/image-20220513093150529.png" alt="image-20220513093150529"/>
</li>
<li>
<p>点击 <code>Server Only</code> 将打包出来的应用作为服务器</p>
<img src="/images/Unity Mirror.assets/image-20220513093323182.png" alt="image-20220513093323182"/>
</li>
<li>
<p>运行 Unity 内的游戏，点击 <code>Client</code> ，作为客户端</p>
<img src="/images/Unity Mirror.assets/image-20220513093437885.png" alt="image-20220513093437885"/>
</li>
<li>
<p>此时可以看到 Client 里面的画面同步到了 Server 上</p>
</li>
<li>
<p>你可以按动上下键控制板子移动，可以观察到 Server 中的画面同步</p>
</li>
<li>
<p>如果在 Server 端点击 <code>Host(Server + Client)</code> 事实上，它会既是一个 Server，又是一个 Client，此时运行 Unity 内的 Client 点击 <code>Client</code> 加入，就可以开始玩了</p>
</li>
</ul>
<h3 id="代码分析">代码分析</h3>
<p>Scene 下有如下的 GameObject</p>
<p><img src="/images/Unity Mirror.assets/image-20220513094140780.png" alt="image-20220513094140780" style="zoom:67%;" /></p>
<h4 id="networkmanager">NetworkManager</h4>
<p>这是控制整个网络的管理器，它的组件如下</p>
<p><img src="/images/Unity Mirror.assets/image-20220513094311369.png" alt="image-20220513094311369" style="zoom:67%;" /></p>
<ul>
<li><code>Dont Destory On Load</code>：当进入一个新场景时，这个组件依旧存在</li>
<li><code>Run In Background</code>：运行在后台</li>
<li><code>Server Tick Rate</code>：高同步的游戏可以设置成 60，一般的游戏 30 就可以</li>
<li><code>Offline Scene</code>：当断开连接的时候，进入的 Scene</li>
<li><code>Online Scene</code>：当连接好的时候，进入的连接</li>
<li><code>Transport</code>：使用哪个传输层协议</li>
<li><code>Network Address</code>：具体连接到哪个 ip 地址</li>
<li><code>Max Connection</code>：最多有多少人连接服务器</li>
<li><code>Authenticator</code>：身份验证，可以添加用户名和密码</li>
<li><code>Player Prefab</code>：当你加入的时候，生成的东西</li>
<li><code>Plaer Spawn Method</code>
<ul>
<li><code>Round Robin</code>：轮流在指定的两个位置生成</li>
<li><code>Random</code>：随机在指定的两个位置生成</li>
</ul>
</li>
<li><code>Left Racket Spawn</code>：左边生成的位置</li>
<li><code>Right Racket Spawn</code>：右边生成的位置</li>
<li><code>Registered Spawnable Prefabs</code>：两边需要同步的内容，在运行时生成</li>
</ul>
<p>代码内部逻辑如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NetworkManagerPong</span> : NetworkManager
{
    <span style="color:#66d9ef">public</span> Transform leftRacketSpawn;
    <span style="color:#66d9ef">public</span> Transform rightRacketSpawn;
    GameObject ball;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnServerAddPlayer(NetworkConnectionToClient conn)
    {
        <span style="color:#75715e">// add player at correct spawn position
</span><span style="color:#75715e"></span>        Transform start = numPlayers == <span style="color:#ae81ff">0</span> ? leftRacketSpawn : rightRacketSpawn;
        GameObject player = Instantiate(playerPrefab, start.position, start.rotation);
        
        <span style="color:#75715e">// 将 Player 分配给特定的 Connection
</span><span style="color:#75715e"></span>        NetworkServer.AddPlayerForConnection(conn, player);

        <span style="color:#75715e">// spawn ball if two players
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (numPlayers == <span style="color:#ae81ff">2</span>)
        {
            <span style="color:#75715e">// 找到共享的 Prefab，将它共享给连接到服务器内所有的玩家
</span><span style="color:#75715e"></span>            ball = Instantiate(spawnPrefabs.Find(prefab =&gt; prefab.name == <span style="color:#e6db74">&#34;Ball&#34;</span>));
            NetworkServer.Spawn(ball);
        }
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnServerDisconnect(NetworkConnectionToClient conn)
    {
        <span style="color:#75715e">// destroy ball
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 连接到服务器内的所有玩家出现的 ball 都会被摧毁
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (ball != <span style="color:#66d9ef">null</span>)
            NetworkServer.Destroy(ball);

        <span style="color:#75715e">// call base functionality (actually destroys the player)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">base</span>.OnServerDisconnect(conn);
    }
}
</code></pre></div><p><img src="/images/Unity Mirror.assets/image-20220513095404372.png" alt="image-20220513095404372" style="zoom:67%;" /></p>
<ul>
<li>这是游戏左上角的 GUI</li>
</ul>
<p><img src="/images/Unity Mirror.assets/image-20220513095444889.png" alt="image-20220513095444889" style="zoom:67%;" /></p>
<ul>
<li><code>Port</code>：运行的端口位置</li>
<li><code>Dual Mode</code>：勾选上同时支持 iPv6 和 iPv4 的广播，如果取消勾选仅支持 iPv4</li>
<li><code>No Delay</code>：降低时延</li>
<li><code>Interval</code>：KCP 内部更新间隔，KCP的默认值是100ms，但是建议使用较低的间隔来最小化延迟并扩展到更多的网络实体</li>
<li><code>Timeout</code>：KCP 超时(毫秒)，注意，KCP会自动发送一个ping</li>
<li>其它的部分是一些网络相关的细节参数，在这里就不过多介绍，可以自行查看</li>
</ul>
<h4 id="ball">Ball</h4>
<p>在 <code>Prefabs</code> 中，存在着需要同步的 Ball Prefab</p>
<p><img src="/images/Unity Mirror.assets/image-20220513100813263.png" alt="image-20220513100813263" style="zoom:67%;" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Ball</span> : NetworkBehaviour
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> speed = <span style="color:#ae81ff">30</span>;
    <span style="color:#66d9ef">public</span> Rigidbody2D rigidbody2d;

    <span style="color:#75715e">// 当 Server 激活它的时候调用该方法 -&gt; 这部分代码只在 Server 上运行
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnStartServer()
    {
        <span style="color:#66d9ef">base</span>.OnStartServer();

        <span style="color:#75715e">// only simulate ball physics on server
</span><span style="color:#75715e"></span>        rigidbody2d.simulated = <span style="color:#66d9ef">true</span>;

        <span style="color:#75715e">// Serve the ball from left player
</span><span style="color:#75715e"></span>        rigidbody2d.velocity = Vector2.right * speed;
    }

    <span style="color:#66d9ef">float</span> HitFactor(Vector2 ballPos, Vector2 racketPos, <span style="color:#66d9ef">float</span> racketHeight)
    {
        <span style="color:#75715e">// ascii art:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ||  1 &lt;- at the top of the racket
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ||
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ||  0 &lt;- at the middle of the racket
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ||
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// || -1 &lt;- at the bottom of the racket
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> (ballPos.y - racketPos.y) / racketHeight;
    }

    <span style="color:#75715e">// only call this on server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [ServerCallback]</span>
    <span style="color:#66d9ef">void</span> OnCollisionEnter2D(Collision2D col)
    {
        <span style="color:#75715e">// Note: &#39;col&#39; holds the collision information. If the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Ball collided with a racket, then:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//   col.gameObject is the racket
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//   col.transform.position is the racket&#39;s position
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//   col.collider is the racket&#39;s collider
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// did we hit a racket? then we need to calculate the hit factor
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (col.transform.GetComponent&lt;Player&gt;())
        {
            <span style="color:#75715e">// Calculate y direction via hit Factor
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">float</span> y = HitFactor(transform.position,
                                col.transform.position,
                                col.collider.bounds.size.y);

            <span style="color:#75715e">// Calculate x direction via opposite collision
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">float</span> x = col.relativeVelocity.x &gt; <span style="color:#ae81ff">0</span> ? <span style="color:#ae81ff">1</span> : -<span style="color:#ae81ff">1</span>;

            <span style="color:#75715e">// Calculate direction, make length=1 via .normalized
</span><span style="color:#75715e"></span>            Vector2 dir = <span style="color:#66d9ef">new</span> Vector2(x, y).normalized;

            <span style="color:#75715e">// Set Velocity with dir * speed
</span><span style="color:#75715e"></span>            rigidbody2d.velocity = dir * speed;
        }
    }
}
</code></pre></div><p><img src="/images/Unity Mirror.assets/image-20220513100756751.png" alt="image-20220513100756751" style="zoom:67%;" /></p>
<ul>
<li>需要有一个 Network Identity 来拥有一个 Network Transform</li>
</ul>
<p><img src="/images/Unity Mirror.assets/image-20220513100853611.png" alt="image-20220513100853611" style="zoom:67%;" /></p>
<ul>
<li><code>Client Authority</code>：如果移动是由客户端做的，那么设置成 True</li>
</ul>
<h2 id="3-unity-多人游戏功能介绍">3. Unity 多人游戏功能介绍</h2>
<p><img src="/images/Unity Mirror1.assets/image-20220515185820672.png" alt="image-20220513100853611" style="zoom:67%;" /></p>
<h3 id="组件">组件</h3>
<h4 id="传输">传输</h4>
<ul>
<li>负责在网络间发送数据，同步数据信息</li>
</ul>
<h4 id="运行">运行</h4>
<ul>
<li>网络顶层，你的服务器/客户端</li>
<li>如果你使用 <code>Mirror</code> 的话，它们都是使用 Unity Build 出来的</li>
</ul>
<h4 id="后端">后端</h4>
<ul>
<li>数据库服务，安全验证，第三方 api 调用</li>
</ul>
<h4 id="舰队">舰队</h4>
<ul>
<li>服务器舰队</li>
<li>分布式，管理更新和补丁，维护服务器 24 小时运行</li>
</ul>
<h3 id="网络拓扑">网络拓扑</h3>
<h4 id="本地多人游戏">本地多人游戏</h4>
<ul>
<li>其实是单机游戏，处理 2-4 个人同时玩</li>
<li>不需要传输/后端</li>
<li>延迟为零</li>
</ul>
<h4 id="lan">LAN</h4>
<ul>
<li>在一定的局域网下运行</li>
<li>不使用互联网，但是需要传输</li>
<li>延迟很小，几乎为零</li>
</ul>
<h4 id="p2p">P2P</h4>
<ul>
<li><strong>对等 P2P</strong>：每个玩家都与其它所有玩家连接
<ul>
<li>很便宜，但是逻辑很难处理</li>
<li>很难扩展</li>
</ul>
</li>
<li><strong>C-S 架构</strong>：其中一个玩家同时承担玩家和服务器的功能，其它玩家连接上它
<ul>
<li>不是所有人的权限是相同的，核心玩家享有零延迟和一些特殊权限</li>
<li>容易作弊</li>
</ul>
</li>
</ul>
<h4 id="委托服务器">委托服务器</h4>
<ul>
<li>专用服务器负责管理（本地/云）</li>
<li>容易扩展和制作功能</li>
<li>开销大</li>
</ul>
<h3 id="架构">架构</h3>
<p><img src="/images/Unity Mirror1.assets/image-20220518180519142.png" alt="image-20220518180519142" style="zoom: 67%;" /></p>
<h4 id="游戏要求">游戏要求</h4>
<ul>
<li>每场比赛支持 60 名玩家</li>
<li>实时游戏动作和物理</li>
<li>身份验证</li>
<li>游戏匹配</li>
<li>好友系统</li>
<li>排行榜</li>
<li>存储玩家数据</li>
<li>分析数据：每日活跃用户/每月活跃用户等</li>
</ul>
<h4 id="服务器">服务器</h4>
<p>采用委托舰队服务器，可以使用云服务器</p>
<ul>
<li>Azure Server</li>
<li>Google Server</li>
<li>Amazon Server</li>
</ul>
<h4 id="身份验证">身份验证</h4>
<ul>
<li>用户名/密码</li>
<li>Playfab Authentication</li>
</ul>
<h4 id="匹配">匹配</h4>
<ul>
<li>玩家 A 发送一个匹配请求，将它提交到匹配服务器上</li>
<li>服务器执行相关算法，匹配到某个房间</li>
<li>当房间里所有玩家接受后，匹配服务器会将房间放到服务器舰队中的某个服务器中</li>
<li>匹配服务器向游戏服务器申请开始，完成会话建立</li>
<li>游戏服务器准备好后，通知匹配服务器</li>
<li>匹配服务器向玩家传递信息，开始游戏</li>
<li>一些比较好的游戏匹配服务
<ul>
<li>flexmatch</li>
<li>openmatch</li>
</ul>
</li>
</ul>
<h4 id="好友系统">好友系统</h4>
<ul>
<li>连接 Steam，Xbox 的好友</li>
<li>连接第三方的 api</li>
<li>使用 playfab 服务</li>
</ul>
<h4 id="排行榜">排行榜</h4>
<ul>
<li>可以使用第三方 api
<ul>
<li>Steamworks api</li>
<li>Playfab api</li>
</ul>
</li>
</ul>
<h4 id="数据库">数据库</h4>
<ul>
<li>可以使用 SQL 数据库
<ul>
<li>Amazon</li>
<li>Azure</li>
<li>Google</li>
</ul>
</li>
</ul>
<h4 id="分析数据">分析数据</h4>
<ul>
<li>gameanalytics.com</li>
</ul>
<h2 id="4-数据同步">4. 数据同步</h2>
<p><img src="/images/Unity Mirror1.assets/image-20220518193424314.png" alt="image-20220518193424314" style="zoom:80%;" /></p>
<h3 id="network-identity">Network Identity</h3>
<p>Mirror 是如何跟踪游戏中的 GameObject 的</p>
<p><img src="/images/Unity Mirror1.assets/image-20220518181425282.png" alt="image-20220518181425282" style="zoom:67%;" /></p>
<ul>
<li>挂载 <code>NetworkIdentity</code> 的 GameObject，可以传输信息</li>
<li>你在运行中产生的所有与网络行为有关的 Prefab，都需要挂载 NetworkIdentity</li>
<li>如果你勾选 <code>Server Only</code> 的话，这个 Prefab 只会在服务器上生成，而不会在客户端</li>
</ul>
<h3 id="network-authority">Network Authority</h3>
<ul>
<li>知道哪个 Object 是属于谁的</li>
</ul>
<h4 id="权限给客户端">权限给客户端</h4>
<p>添加权限</p>
<ul>
<li><code>NetworkSetver.AddPlayerForConnection(conn, player)</code>
<ul>
<li>添加一个 player prefab</li>
<li>是 conn 的那个  client 拥有处理该 prefab 的能力</li>
</ul>
</li>
<li><code>NetworkServer.Spawn(obj, connectionToClient)</code></li>
<li><code>NetworkIdentity.AssignClientAuthroity(conn)</code></li>
</ul>
<p>取消权限</p>
<ul>
<li><code>NetworkIdentity.RemoveClientAuthority()</code></li>
<li><code>NetworkServer.ReplacePlayerForConnection(conn, player)</code>
<ul>
<li>取消 player object 的权限</li>
</ul>
</li>
</ul>
<h3 id="回调">回调</h3>
<p>Mirror 提供很多回调函数，用于各种情况下的事件处理</p>
<h4 id="networkmanager-1">NetworkManager</h4>
<table>
<thead>
<tr>
<th>回调函数</th>
<th>Server</th>
<th>Client</th>
</tr>
</thead>
<tbody>
<tr>
<td>Start</td>
<td><code>OnStartServer</code><br /><code>OnServerSceneChanged</code></td>
<td><code>OnStartClient</code><br /><code>OnClientConnect</code><br /><code>OnClientChangeScene</code><br /><code>OnClientSceneChanged</code></td>
</tr>
<tr>
<td>Client Connect</td>
<td><code>OnServerConnect</code><br /><code>OnServerReady</code><br /><code>OnServerAddPlayer</code></td>
<td></td>
</tr>
<tr>
<td>Client Disconnect</td>
<td><code>OnServerDisconnect</code></td>
<td></td>
</tr>
<tr>
<td>Stop</td>
<td><code>OnStopServer</code></td>
<td><code>OnStopClient</code><br /><code>OnClientDisconnect</code></td>
</tr>
</tbody>
</table>
<h4 id="networkbehavior">NetworkBehavior</h4>
<table>
<thead>
<tr>
<th></th>
<th>Server</th>
<th>Client</th>
</tr>
</thead>
<tbody>
<tr>
<td>Start</td>
<td><code>OnStartServer</code></td>
<td><code>OnStartClient</code><br /><code>OnStartLocalServer</code></td>
</tr>
<tr>
<td>Authority</td>
<td></td>
<td><code>OnStartAuthority</code><br /><code>OnStopAuthority</code></td>
</tr>
<tr>
<td>Stop</td>
<td><code>OnStopServer</code></td>
<td><code>OnStopClient</code></td>
</tr>
</tbody>
</table>
<h3 id="属性">属性</h3>
<h4 id="client">[Client]</h4>
<ul>
<li>标识只在客户端执行该函数</li>
</ul>
<h4 id="server">[Server]</h4>
<ul>
<li>标识只在服务器执行该函数</li>
</ul>
<h4 id="command">[Command]</h4>
<ul>
<li>客户端调用，但是会在服务器执行</li>
<li>只有自己的 Player Object / 有客户端权限的 GameObject / [Command(ignoreAuthority = true)] 可以执行该函数</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[Commabd]</span>
<span style="color:#66d9ef">void</span> MyCommand()
{

}
</code></pre></div><p>我们只能传输下面的数据类型</p>
<ul>
<li>Primitive(byte, int, float, string, etc)</li>
<li>Built-in Unity math(Vector3, Quaternion, etc)</li>
<li>Arrays of Primitive type</li>
<li>Structs containing these allowable type</li>
<li>NetworkIdentity</li>
<li>GameObject with NetworkIdentity</li>
</ul>
<h4 id="clientrpc">[ClientRpc]</h4>
<ul>
<li>服务器调用，所有客户端执行</li>
<li>可以发送给所有已经生成的 NetworkIdentity</li>
<li>服务器有权限，所以所有的 server 都可以调用 client rpc</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[ClientRpc]</span>
<span style="color:#66d9ef">void</span> MyClientRPC()
{

}
</code></pre></div><ul>
<li>同理，我们只能传输指定的数据类型</li>
</ul>
<h4 id="targetrpc">[TargetRpc]</h4>
<ul>
<li>服务器调用，指定的客户端执行</li>
<li>服务器的 GameObject 调用后，在指定的客户端的相同的 GameObject 执行</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[TargetRpc]</span>
<span style="color:#66d9ef">void</span> MyTargetRPC(NetworkConnection conn)
{
    <span style="color:#75715e">// 以 NetworkConnection 作为参数开头的
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 指定的 conn 执行该函数
</span><span style="color:#75715e"></span>}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[TargetRpc]</span>
<span style="color:#66d9ef">void</span> MyTargetRPC()
{
    <span style="color:#75715e">// 以其它参数或者空参数开头的
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 所有脚本上拥有这段代码的执行该函数
</span><span style="color:#75715e"></span>}
</code></pre></div><h4 id="syncvars">[SyncVars]</h4>
<ul>
<li>属性，在客户端和服务器之间同步</li>
<li>只有继承 NetworkBehavior 的类才可以同步</li>
<li>只能由服务器向客户端同步，客户端不能给服务器同步</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[SyncVar]</span>
<span style="color:#66d9ef">int</span> x;
</code></pre></div><ul>
<li>当属性改变了触发某个函数</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[SyncVar(hook = OnChange)]</span>
<span style="color:#66d9ef">int</span> x;

<span style="color:#66d9ef">void</span> OnChnage(<span style="color:#66d9ef">int</span> oldX, <span style="color:#66d9ef">int</span> newX)
{
	<span style="color:#75715e">// 处理改变的回调函数
</span><span style="color:#75715e"></span>}
</code></pre></div>
        </p>
    </div>

    <div class="prev-next">
        
            
                
<div class="prev-post">
    <p>
        <a href="/en/games/unity-itween-%E5%8A%A8%E7%94%BB%E6%8F%92%E4%BB%B6/">
            &#8592;
            Previous:
            Unity iTween 动画插件
        </a>
    </p>
    <p class="prev-post-date">
        May 6, 2022
    </p>
</div>



<div class="next-post">
    <p>
        <a href="/en/games/unity-oculus-sdk/">
            Next:
            Unity Oculus SDK
            &#8594;
        </a>
    </p>
        <p class="next-post-date">
            July 1, 2022
        </p>
</div>


            
        
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-mirror-介绍">1. Mirror 介绍</a>
          <ul>
            <li><a href="#安装">安装</a></li>
          </ul>
        </li>
        <li><a href="#2-pong-游戏介绍">2. Pong 游戏介绍</a>
          <ul>
            <li><a href="#介绍">介绍</a></li>
            <li><a href="#代码分析">代码分析</a>
              <ul>
                <li><a href="#networkmanager">NetworkManager</a></li>
                <li><a href="#ball">Ball</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#3-unity-多人游戏功能介绍">3. Unity 多人游戏功能介绍</a>
          <ul>
            <li><a href="#组件">组件</a>
              <ul>
                <li><a href="#传输">传输</a></li>
                <li><a href="#运行">运行</a></li>
                <li><a href="#后端">后端</a></li>
                <li><a href="#舰队">舰队</a></li>
              </ul>
            </li>
            <li><a href="#网络拓扑">网络拓扑</a>
              <ul>
                <li><a href="#本地多人游戏">本地多人游戏</a></li>
                <li><a href="#lan">LAN</a></li>
                <li><a href="#p2p">P2P</a></li>
                <li><a href="#委托服务器">委托服务器</a></li>
              </ul>
            </li>
            <li><a href="#架构">架构</a>
              <ul>
                <li><a href="#游戏要求">游戏要求</a></li>
                <li><a href="#服务器">服务器</a></li>
                <li><a href="#身份验证">身份验证</a></li>
                <li><a href="#匹配">匹配</a></li>
                <li><a href="#好友系统">好友系统</a></li>
                <li><a href="#排行榜">排行榜</a></li>
                <li><a href="#数据库">数据库</a></li>
                <li><a href="#分析数据">分析数据</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#4-数据同步">4. 数据同步</a>
          <ul>
            <li><a href="#network-identity">Network Identity</a></li>
            <li><a href="#network-authority">Network Authority</a>
              <ul>
                <li><a href="#权限给客户端">权限给客户端</a></li>
              </ul>
            </li>
            <li><a href="#回调">回调</a>
              <ul>
                <li><a href="#networkmanager-1">NetworkManager</a></li>
                <li><a href="#networkbehavior">NetworkBehavior</a></li>
              </ul>
            </li>
            <li><a href="#属性">属性</a>
              <ul>
                <li><a href="#client">[Client]</a></li>
                <li><a href="#server">[Server]</a></li>
                <li><a href="#command">[Command]</a></li>
                <li><a href="#clientrpc">[ClientRpc]</a></li>
                <li><a href="#targetrpc">[TargetRpc]</a></li>
                <li><a href="#syncvars">[SyncVars]</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2024 NYH-Dolphin</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
